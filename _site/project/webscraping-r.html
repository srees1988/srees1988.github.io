<!doctype html>

<html class="no-js" lang="en">

<head>


	<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

	Sree

	Journal Theme by https://jekyllthemes.io
	Premium + free Jekyll themes for your blog or website.

	- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->


	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<!-- Page Info -->
	<link rel="shortcut icon" href="/images/favicon.png">
	<title>Web Scraping in R – Sree</title>
	<meta name="description" content="<style>
body {
text-align: justify}
</style>

">

	<!-- Twitter Card -->
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="Web Scraping in R – Sree">
	<meta name="twitter:description" content="<style>
body {
text-align: justify}
</style>

">
	<meta name="twitter:image:src" content="http://localhost:4000/images/web_scraping1.jpg">

	<!-- Facebook OpenGraph -->
	<meta property="og:title" content="Web Scraping in R – Sree" />
	<meta property="og:description" content="<style>
body {
text-align: justify}
</style>

" />
	<meta property="og:image" content="http://localhost:4000/images/web_scraping1.jpg" />

	
	<!-- Font Embed Code -->
	<link href="https://fonts.googleapis.com/css?family=Merriweather:300,400|Muli:400,400i,600" rel="stylesheet">
	

	<!-- Styles -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/css/style.css">
	
	<!-- Icons -->
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/solid.js" integrity="sha384-GXi56ipjsBwAe6v5X4xSrVNXGOmpdJYZEEh/0/GqJ3JTHsfDsF8v0YQvZCJYAiGu" crossorigin="anonymous"></script>
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/brands.js" integrity="sha384-0inRy4HkP0hJ038ZyfQ4vLl+F4POKbqnaUB6ewmU4dWP0ki8Q27A0VFiVRIpscvL" crossorigin="anonymous"></script>
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/fontawesome.js" integrity="sha384-NY6PHjYLP2f+gL3uaVfqUZImmw71ArL9+Roi9o+I4+RBqArA2CfW1sJ1wkABFfPe" crossorigin="anonymous"></script>

	
	<!-- Custom Styles -->
	<style></style>
	

	
	<!-- Analytics Code -->
	
	

	
	<!-- Extra Header JS Code -->
	
	
	
</head>


<body class="loading ajax-loading" data-site-url="http://localhost:4000" data-page-url="/project/webscraping-r">


	<header class="header">

	<div class="header-image header-image--on" style="background-image: url(/images/web_scraping1.jpg);"></div>
	<div class="header-image"></div>

	<div class="header-overlay"></div>

	<div class="header__content">

		
		<a href="/" class="header__title">
			Sree
		</a>
		

		<p class="header__tagline">Marketing Data Scientist</p>

		<div class="menu">
			<div class="menu__toggle js-menu-toggle">
				<div class="menu__toggle__icon"><span></span></div>
			</div>
			<div class="menu__wrap">
				<ul class="menu__list">
					
					<li class="menu__list__item">
						<a href="/" class="menu__list__item__link">Latest</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/projects/" class="menu__list__item__link">Projects</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/about" class="menu__list__item__link">About</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/contact" class="menu__list__item__link">Contact</a>
					</li>
					
				</ul>
				<ul class="socials">
	
	
	
	
	<li class="socials__item">
		<a href="https://twitter.com/srees1988" target="_blank" class="socials__item__link" title="Twitter">
			<i class="fab fa-twitter" aria-hidden="true"></i>
		</a>
	</li>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://github.com/srees1988" target="_blank" class="socials__item__link" title="Github">
			<i class="fab fa-github" aria-hidden="true"></i>
		</a>
	</li>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://linkedin.com/in/srees1988/" target="_blank" class="socials__item__link" title="Linkedin">
			<i class="fab fa-linkedin" aria-hidden="true"></i>
		</a>
	</li>
	
	
</ul>
			</div>
		</div>

	</div>

</header>


	<div class="loader"><svg width="120" height="30" viewBox="0 0 120 30" xmlns="http://www.w3.org/2000/svg"><circle cx="15" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite" /></circle><circle cx="60" cy="15" r="9" fill-opacity="0.3"><animate attributeName="r" from="9" to="9" begin="0s" dur="0.8s" values="9;15;9" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="0.5" to="0.5" begin="0s" dur="0.8s" values=".5;1;.5" calcMode="linear" repeatCount="indefinite" /></circle><circle cx="105" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite" /></circle></svg></div>

	<div class="page-loader"></div>

	
	<div class="page">

		<div class="page__content" data-page-title="Web Scraping in R – Sree" data-image="/images/web_scraping1.jpg">

			<section class="intro">

	<div class="wrap">

		<h1>Web Scraping in R</h1>
		<p>Geospatial Competitor Analysis</p>

	</div>

</section>

<section class="single">

	<div class="wrap">

		<style>
body {
text-align: justify}
</style>

<h3 id="objective">Objective</h3>

<p>To fetch the latest product prices that has been hosted on the competitor’s website programmatically.</p>

<h3 id="details">Details</h3>

<p>For the purpose of demonstration, let’s look into the websites of Wework and Regus; two leading players in the co-working industry who competes among each other to serve hot desks, dedicated desks and private offices across the globe. Let’s try to scrap their websites in California to retrieve the latest product price listings programmatically.</p>

<p>There were four milestones to accomplish the objective:</p>

<ol>
  <li>Web scraped Regus sites using httr/rvest packages.</li>
  <li>Cleaned the dataset and incorporated geospatial co-ordinates.</li>
  <li>Repeated the steps 1 &amp; 2 for Wework websites.</li>
  <li>Embeded R script in Power BI and visualized the final output.</li>
</ol>

<h4 id="phase-1-web-scraped-regus-sites-using-httrrvest-packages">Phase 1: Web scraped Regus sites using httr/rvest packages</h4>

<ul>
  <li>Step 1.1. Imported Libraries: Imported all the relevant libraries upfront.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>library(tidyverse)
library(rvest)
library(revgeo)
library("opencage")
library(dplyr)
library(sqldf)
library(formattable)
library(stringr)
library(ngram)
library(httr)
library(rlist)
library(jsonlite)
library(lubridate)
library(splitstackshape)
</code></pre></div></div>
<ul>
  <li>Step 1.2. Regus Location API: Extracted the co-working locations in California from Regus location API using httr package.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>options(warn=-1)
time &lt;- Sys.time()
location_data_final &lt;- data.frame()

url &lt;- "https://www.regus.com/api/search/centres"

resp &lt;- GET(url)
http_type(resp)
jsonRespText&lt;-content(resp,as="text") 
jsonRespParsed&lt;-content(resp,as="parsed") 

regus_locations &lt;-fromJSON(jsonRespText) 
regus_locations &lt;- regus_locations %&gt;%  select (CenterNumber
                                                ,CenterName 
                                                ,Latitude,Longitude
                                                ,FormattedAddress 
                                                ,CenterCity)
                             
</code></pre></div></div>

<h4 id="phase-2-cleaned-the-dataset-and-incorporated-geospatial-co-ordinates">Phase 2: Cleaned the dataset and incorporated geospatial co-ordinates.</h4>

<ul>
  <li>Step 2.1. Reverse Geocoding: Used revgeo package to identify the street, city, state and country of the lat, lng co-ordinates.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reverse_geocode&lt;- revgeo(longitude=regus_locations$Longitude
                         ,latitude=regus_locations$Latitude
                         ,output='frame')

reverse_geocode &lt;- cbind(regus_locations, reverse_geocode)

regus_locations_full  &lt;- regus_locations %&gt;% inner_join (
                         reverse_geocode, by = c("CenterNumber"))

regus_california &lt;- regus_locations_full %&gt;%  filter(
                      country == "United States of America"
                     ,State == "California")

</code></pre></div></div>
<ul>
  <li>Step 2.2. Regus Product Pricing API: Extracted the Regus co-working product pricing per locations in California. Finally wrapped the whole process of data extraction with a ‘for loop’.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dedicated_desk &lt;- data.frame()
for (i in 1: as.integer(regus_california %&gt;% summarise(n()))){

#Status Code 500 Path

url &lt;- paste("https://www.regus.com/ecommercevo/price?
productType=platinum&amp;daysLength=30&amp;monthLength=1
&amp;startDate=", Sys.Date(),"&amp;countryCode=US
&amp;centreNumber=",regus_california$CenterNumber[i], sep ="")
  
resp &lt;- GET(url)
  
if(resp$status_code == 500){
url &lt;- paste("https://www.regus.com/ecommercevo/price?
productType=platinum&amp;monthLength=1&amp;startDate=", Sys.Date(),"
&amp;countryCode=US&amp;centreNumber=", "&amp;_=",as.integer(
as.numeric(Sys.time())),924,sep ="")

resp &lt;- GET(url)
jsonRespText&lt;-content(resp,as="text") 
vo_list &lt;-fromJSON(jsonRespText)
    
if(!is.null(vo_list$Price)){
dedicated_desk_temp &lt;-  as_data_frame(
vo_list$Price)%&gt;%rename(dedicated_desk_price=value)
dedicated_desk_temp$center_number &lt;- 
as.integer (regus_california$CenterNumber[i])}

if(is.null(vo_list$Price)){
dedicated_desk_temp &lt;-  as_data_frame( "$0" ) %&gt;% 
rename( dedicated_desk_price =value)
dedicated_desk_temp$center_number &lt;- as.integer(
regus_california$CenterNumber[i])}

dedicated_desk &lt;- rbind(dedicated_desk, dedicated_desk_temp)}
  
else if (resp$status_code == 200){
jsonRespText&lt;-content(resp,as="text") 
vo_list &lt;-fromJSON(jsonRespText)
 
if(!is.null(vo_list$Price)){
dedicated_desk_temp &lt;-  as_data_frame( 
vo_list$Price) %&gt;% rename(dedicated_desk_price=value)
dedicated_desk_temp$center_number &lt;- as.integer ( 
regus_california$CenterNumber[i])}

if(is.null(vo_list$Price)){
dedicated_desk_temp &lt;-  as_data_frame( "$0" ) %&gt;% 
rename(dedicated_desk_price =value)
dedicated_desk_temp$center_number &lt;- 
as.integer (regus_california$CenterNumber[i])
    }
    dedicated_desk &lt;- rbind(dedicated_desk, dedicated_desk_temp)
  }
}

regus_california &lt;- regus_california %&gt;%  left_join(
dedicated_desk, by = c("CenterNumber" = "center_number"))

</code></pre></div></div>

<h4 id="phase-3-web-scraped--cleaned-wework-datasets">Phase 3: Web scraped &amp; Cleaned Wework datasets</h4>

<ul>
  <li>Step 3.1. Wework Product Pricing API: Extracted the Wework co-working product pricing per locations in California. Finally wrapped the whole process of data extraction with a ‘for loop’.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>url &lt;- c("https://www.wework.com/l/sf-bay-area--CA")

location_data_final &lt;- data.frame()

for(i in url){ 
webpage &lt;- read_html(i)
location_data &lt;- 
html_nodes(webpage, ".mb0, .ray-card__content") %&gt;%
html_text() %&gt;%
enframe()
location_data$urlid &lt;- i
location_data_final &lt;- rbind(location_data_final
                       ,location_data)}

wework_1.a &lt;- location_data_final %&gt;%  select (value) 
%&gt;%  mutate (row_num = row_number(),filter_check = row_num%%2==0) 
%&gt;%  filter(filter_check == "TRUE")%&gt;%  select (
-filter_check)%&gt;%  select(-row_num) %&gt;%  rename(
                        site_name_short = value)


wework_1.b &lt;- location_data_final %&gt;%  select (value) %&gt;%  mutate (
row_num = row_number(),filter_check = row_num%%2!=0 ) %&gt;%  filter(
filter_check == "TRUE")%&gt;%  select (-filter_check)%&gt;%  select(
-row_num) 

wework_1 &lt;- cbind(wework_1.a, wework_1.b)
</code></pre></div></div>

<ul>
  <li>Step 3.2. Cleaned wework dataset: Cleaned the raw dataset by extracting the required information out of the Wework dataset</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wework_1 &lt;- wework_1 %&gt;% rename (full_info = value) %&gt;% mutate(
                             full_info = str_squish (full_info))

wework_1 &lt;- sqldf("select * from wework_1 
            where full_info not like '%Pricing for this location 
            is not yet available%'")

wework_1 &lt;- sqldf("select * from wework_1 
            where full_info not like '%Move in ahead of the curve 
            with special pre-opening rates%'")

wework_1.1 &lt;- str_split_fixed(wework_1$full_info, 
              "Starting prices", 2) %&gt;% as.data.frame()

wework_1.2 &lt;- as.data.frame(wework_1.1$V2) 
              %&gt;% rename (value = `wework_1.1$V2`)

wework_1.2 &lt;- separate(wework_1.2, value, 
              c("Private Office", "Price"), 
              sep = "Private Office")

wework_1.2 &lt;- separate(wework_1.2, Price, 
              c("private_office_price", "Price"), 
              sep = "Dedicated Desk") 

wework_1.2 &lt;- separate(wework_1.2, Price, 
              c("dedicated_desk_price", "hot_desk_price"), 
              sep = "Hot Desk")

wework_interim &lt;- cbind(wework_1, wework_1.1, wework_1.2) 
                  %&gt;%  select(-full_info,-V2) 
                  %&gt;%  rename(site_name = V1) 


wordcount_final &lt;- data.frame()

for(i in 1: nrow(wework_interim)){wordcount_temp &lt;-  
enframe ( wordcount
(wework_interim$site_name_short[i]) ) %&gt;% select (value)

wordcount_final  &lt;- rbind(wordcount_final, wordcount_temp)}


wework_pricing &lt;- cbind(wework_interim, wordcount_final) %&gt;%  rename(
                  word_count= value) %&gt;%  select (-`Private Office`) 
                  %&gt;%  mutate(building_name = 
                  word(site_name, word_count+1, -1)) 
                  %&gt;%  select(-word_count) 
                  %&gt;% mutate(site_name = building_name
                  ,date_time_Stamp = format(Sys.time()
                  ,  "%d-%m-20%y"),country = "United States"
                  ,company =  "wework", currency_name = "US Dollar"
                  , currency_short = "USD" 
                  , web_url = "https://www.wework.com/l/united-states")
</code></pre></div></div>

<ul>
  <li>Step 3.3. Reverse Geocoding: Used revgeo package to identify the street, city, state and country of the lat, lng co-ordinates.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>output_final_lat  &lt;- data.frame()
output_final_lng &lt;- data.frame()
output_final_state  &lt;- data.frame()


for (i in 1:length(wework_pricing$site_name)) {
output_temp &lt;- opencage_forward(placename = wework_pricing$site_name[i]
, key = "d3f30e7282414d52ba36461e84613c34" )

output_final_lat  &lt;- bind_rows (output_final_lat, 
enframe( output_temp$results$geometry.lat[[1]] ))

output_final_lng  &lt;- bind_rows (output_final_lng, 
enframe( output_temp$results$geometry.lng[[1]] ))

output_final_state  &lt;- bind_rows (output_final_state, 
enframe( output_temp$results$components.state[[1]]))}


wework_pricing$lat &lt;- output_final_lat$value
wework_pricing$lng &lt;- output_final_lng$value
wework_pricing$state &lt;- output_final_state$value 


reverse_geocode&lt;- revgeo(longitude=wework_pricing$lng, 
latitude=wework_pricing$lat, output='frame')

wework_pricing &lt;- wework_pricing %&gt;% mutate(
  street_name = word(site_name, 2, 3),
  city        = reverse_geocode$city,
  postcode    = reverse_geocode$zip ) 


</code></pre></div></div>

<h4 id="phase-4-embeded-r-script-in-power-bi-and-visualized-the-final-output">Phase 4: Embeded R script in Power BI and visualized the final output:</h4>

<div class="gallery" data-columns="1">
	<img src="/images/webscraping2.png" />
	<img src="/images/webscraping3.png" />
	<img src="/images/webscraping4.png" />
</div>

<h3 id="conclusion">Conclusion</h3>

<p>So, in a nutshell, we have successfully extracted the price listings per product per location of two competitors using the web scraping techniques in R programming. Finally we visualized the output on a geospatial scale to build the data story.</p>

<h3 id="whats-next">What’s Next?</h3>

<p>This is just the starting point of a journey to endless possibilities in competitor intelligence. We could do so much more with the extracted data like the following:</p>

<ul>
  <li>Expand the web harvesting technique to build and analyze the trend globally.</li>
  <li>Automate the whole process of data extraction to build a real-time product pricing model.</li>
  <li>Feed the daily product price listings into a cloud storage (S3/Google Cloud) to monitor the competitor’s daily price fluctuations in a BI platform.</li>
  <li>Aggregate the price listings per product per location over a period of time to reap insights from the week on week/ month on month/ year on year analysis.</li>
  <li>Auto-compute the avg. product price per city to see if we are underpriced or overpriced in comparison to the competitor’s price listings at any point in time.</li>
</ul>

<h3 id="github-repository">GitHub Repository</h3>

<p>I have learnt (and continue to learn) from many folks in Github. Hence sharing my entire R scripts and Power BI file in a public <a href="https://github.com/srees1988/webscraping-in-r/tree/master">GitHub Repository</a> incase if it benefits any seekers online. Also, feel free to reach out to me if you need any help in understanding the fundamentals of web scraping in R. Happy to share what I know:) Hope this helps!</p>



	</div>

</section>

		</div>

	</div>


	<footer class="footer">

	<div class="footer__copyright">
	<font color="Grey">	<span>© 2019 Sree.</span></font>
		<style>.heart{color:#e25555;}</style>
                <font color="Grey">Hosted with</font> <span class="heart">❤</span> <font color="Grey">by</font> <span style="font-weight:bold"><font color="Grey">Github</font></span>
	
	</div>

</footer>



	<!-- Javascript Assets -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="/js/journal-min.js"></script>

	
	<!-- Extra Footer JS Code -->
	
	


</body>

</html>